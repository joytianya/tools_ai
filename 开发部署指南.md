# MatrixTools å¼€å‘ä¸éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ](#å¼€å‘ç¯å¢ƒ-vs-ç”Ÿäº§ç¯å¢ƒ)
2. [å¼€å‘æµç¨‹è¯¦è§£](#å¼€å‘æµç¨‹è¯¦è§£)
3. [éƒ¨ç½²ä¸Šçº¿æµç¨‹](#éƒ¨ç½²ä¸Šçº¿æµç¨‹)
4. [PM2 è¿›ç¨‹ç®¡ç†](#pm2-è¿›ç¨‹ç®¡ç†)
5. [è‡ªåŠ¨é‡å¯æœºåˆ¶](#è‡ªåŠ¨é‡å¯æœºåˆ¶)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ”„ å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒç‰¹ç‚¹
```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
npm run dev
# ä½¿ç”¨ Next.js å¼€å‘æœåŠ¡å™¨ + Turbopack
```

**ç‰¹æ€§ï¼š**
- âœ… **çƒ­é‡è½½** - ä»£ç ä¿®æ”¹åè‡ªåŠ¨åˆ·æ–°
- âœ… **æºç æ˜ å°„** - ä¾¿äºè°ƒè¯•
- âœ… **è¯¦ç»†é”™è¯¯ä¿¡æ¯** - å®Œæ•´çš„é”™è¯¯å †æ ˆ
- âœ… **æœªå‹ç¼©ä»£ç ** - ä¾¿äºé˜…è¯»å’Œè°ƒè¯•
- âš ï¸ **æ€§èƒ½è¾ƒæ…¢** - åŒ…å«è°ƒè¯•ä¿¡æ¯
- âš ï¸ **å†…å­˜å ç”¨é«˜** - å¼€å‘å·¥å…·å ç”¨èµ„æº

### ç”Ÿäº§ç¯å¢ƒç‰¹ç‚¹
```bash
# ç”Ÿäº§ç¯å¢ƒæ„å»ºå’Œå¯åŠ¨
npm run build
npm start
```

**ç‰¹æ€§ï¼š**
- âœ… **ä»£ç ä¼˜åŒ–** - å‹ç¼©ã€Tree-shaking
- âœ… **æ€§èƒ½æœ€ä½³** - é™æ€èµ„æºä¼˜åŒ–
- âœ… **å®‰å…¨æ€§é«˜** - ç§»é™¤å¼€å‘å·¥å…·
- âœ… **ä½“ç§¯æœ€å°** - åˆ é™¤æœªä½¿ç”¨ä»£ç 
- âŒ **æ— çƒ­é‡è½½** - éœ€è¦é‡å¯åº”ç”¨
- âŒ **é”™è¯¯ä¿¡æ¯ç®€åŒ–** - ç”¨æˆ·å‹å¥½çš„é”™è¯¯é¡µé¢

---

## ğŸ› ï¸ å¼€å‘æµç¨‹è¯¦è§£

### 1. æœ¬åœ°å¼€å‘å¯åŠ¨
```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æµè§ˆå™¨è®¿é—®
open http://localhost:3000
```

### 2. å¼€å‘ç¯å¢ƒç‰¹æ€§
```javascript
// next.config.js - å¼€å‘ç¯å¢ƒé…ç½®
/** @type {import('next').NextConfig} */
const nextConfig = {
  // å¼€å‘ç¯å¢ƒä¸‹çš„çƒ­é‡è½½å’Œé”™è¯¯å¤„ç†
  reactStrictMode: true,
  swcMinify: true,

  // å¼€å‘ç¯å¢ƒç‰¹æœ‰é…ç½®
  experimental: {
    turbo: {
      // Turbopack é…ç½®
    }
  }
}
```

### 3. å¼€å‘è°ƒè¯•å·¥å…·
- **Next.js DevTools** - æ€§èƒ½åˆ†æ
- **React DevTools** - ç»„ä»¶è°ƒè¯•
- **æµè§ˆå™¨æ§åˆ¶å°** - å®æ—¶æ—¥å¿—
- **æºç æ˜ å°„** - ç²¾ç¡®å®šä½é”™è¯¯

---

## ğŸš€ éƒ¨ç½²ä¸Šçº¿æµç¨‹

### 1. æ„å»ºä¼˜åŒ–
```bash
# ç”Ÿäº§ç¯å¢ƒæ„å»º
npm run build
# è¾“å‡º: .next æ–‡ä»¶å¤¹åŒ…å«ä¼˜åŒ–åçš„åº”ç”¨

# æ£€æŸ¥æ„å»ºç»“æœ
ls -la .next/
```

### 2. ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
```bash
# æ–¹å¼ä¸€ï¼šç›´æ¥å¯åŠ¨
npm start

# æ–¹å¼äºŒï¼šä½¿ç”¨ PM2
pm2 start ecosystem.config.js
```

### 3. æ„å»ºäº§ç‰©è¯´æ˜
```
.next/
â”œâ”€â”€ static/          # é™æ€èµ„æºï¼ˆCSSã€JSã€å›¾ç‰‡ï¼‰
â”œâ”€â”€ server/          # æœåŠ¡ç«¯æ¸²æŸ“æ–‡ä»¶
â”œâ”€â”€ cache/           # æ„å»ºç¼“å­˜
â””â”€â”€ standalone/      # ç‹¬ç«‹éƒ¨ç½²æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```

### 4. ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env.production
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://api.matrixtools.cn
NEXT_PUBLIC_SITE_URL=https://matrixtools.cn
```

---

## âš™ï¸ PM2 è¿›ç¨‹ç®¡ç†

### 1. PM2 é…ç½®æ–‡ä»¶
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'matrixtools',
    script: 'npm',
    args: 'start',
    cwd: '/path/to/matrixtools',

    // è¿›ç¨‹ç®¡ç†
    instances: 2,                    // å¯åŠ¨2ä¸ªå®ä¾‹
    exec_mode: 'cluster',           // é›†ç¾¤æ¨¡å¼

    // è‡ªåŠ¨é‡å¯é…ç½®
    watch: false,                   // ç”Ÿäº§ç¯å¢ƒä¸ç›‘å¬æ–‡ä»¶å˜åŒ–
    max_memory_restart: '1G',       // å†…å­˜è¶…è¿‡1Gæ—¶é‡å¯

    // ç¯å¢ƒå˜é‡
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },

    // æ—¥å¿—é…ç½®
    out_file: './logs/out.log',
    error_file: './logs/error.log',
    log_file: './logs/combined.log',
    time: true,

    // é‡å¯ç­–ç•¥
    autorestart: true,              // è‡ªåŠ¨é‡å¯
    max_restarts: 10,               // æœ€å¤§é‡å¯æ¬¡æ•°
    min_uptime: '10s',              // æœ€å°è¿è¡Œæ—¶é—´
    restart_delay: 4000,            // é‡å¯å»¶è¿Ÿ
  }]
}
```

### 2. PM2 å¸¸ç”¨å‘½ä»¤
```bash
# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status
pm2 list

# é‡å¯åº”ç”¨
pm2 restart matrixtools
pm2 reload matrixtools    # é›¶åœæœºé‡å¯

# åœæ­¢åº”ç”¨
pm2 stop matrixtools
pm2 delete matrixtools

# æŸ¥çœ‹æ—¥å¿—
pm2 logs matrixtools
pm2 logs matrixtools --lines 100

# ç›‘æ§
pm2 monit
```

### 3. PM2 é›†ç¾¤æ¨¡å¼
```bash
# å¯åŠ¨å¤šä¸ªå®ä¾‹ï¼ˆåˆ©ç”¨å¤šæ ¸CPUï¼‰
pm2 start npm --name "matrixtools" -- start -i max

# æˆ–åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®
instances: 'max'  # æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è®¾ç½®
```

---

## ğŸ”„ è‡ªåŠ¨é‡å¯æœºåˆ¶

### 1. PM2 è‡ªåŠ¨é‡å¯è§¦å‘æ¡ä»¶
```javascript
// ecosystem.config.js é‡å¯é…ç½®è¯¦è§£
{
  // å†…å­˜é™åˆ¶é‡å¯
  max_memory_restart: '1G',        // å†…å­˜è¶…è¿‡1GBé‡å¯

  // å¼‚å¸¸é‡å¯
  autorestart: true,               // è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
  max_restarts: 10,                // 1åˆ†é’Ÿå†…æœ€å¤§é‡å¯10æ¬¡
  min_uptime: '10s',               // è¿›ç¨‹è‡³å°‘è¿è¡Œ10ç§’æ‰ç®—å¯åŠ¨æˆåŠŸ

  // å®šæ—¶é‡å¯
  cron_restart: '0 2 * * *',       // æ¯å¤©å‡Œæ™¨2ç‚¹é‡å¯

  // æ–‡ä»¶å˜åŒ–é‡å¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
  watch: ['src'],                  // ç›‘å¬ src ç›®å½•å˜åŒ–
  ignore_watch: ['node_modules', 'logs'],

  // é‡å¯å»¶è¿Ÿ
  restart_delay: 4000,             // é‡å¯é—´éš”4ç§’
}
```

### 2. System çº§åˆ«è‡ªåŠ¨é‡å¯

#### Systemd æœåŠ¡é…ç½®
```ini
# /etc/systemd/system/matrixtools.service
[Unit]
Description=MatrixTools Website
After=network.target

[Service]
Type=forking
User=www-data
WorkingDirectory=/var/www/matrixtools
ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
ExecReload=/usr/bin/pm2 reload ecosystem.config.js
ExecStop=/usr/bin/pm2 stop ecosystem.config.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### å¯ç”¨ Systemd æœåŠ¡
```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶å
sudo systemctl daemon-reload
sudo systemctl enable matrixtools
sudo systemctl start matrixtools

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status matrixtools
```

### 3. é‡å¯æœºåˆ¶å¯¹æ¯”

| é‡å¯ç±»å‹ | è§¦å‘æ¡ä»¶ | é‡å¯é€Ÿåº¦ | æ•°æ®ä¿æŠ¤ | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|----------|----------|
| **PM2 çƒ­é‡å¯** | ä»£ç æ›´æ–° | å¿«é€Ÿ(2-3ç§’) | âœ… ä¿æŠ¤ | ä»£ç éƒ¨ç½² |
| **PM2 å¼‚å¸¸é‡å¯** | è¿›ç¨‹å´©æºƒ | å¾ˆå¿«(1-2ç§’) | âŒ å¯èƒ½ä¸¢å¤± | å¼‚å¸¸æ¢å¤ |
| **PM2 å†…å­˜é‡å¯** | å†…å­˜è¶…é™ | å¿«é€Ÿ(2-3ç§’) | âœ… ä¿æŠ¤ | å†…å­˜æ³„æ¼é˜²æŠ¤ |
| **System é‡å¯** | ç³»ç»Ÿé‡å¯ | æ…¢(30-60ç§’) | âœ… ä¿æŠ¤ | æœåŠ¡å™¨é‡å¯ |

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. PM2 ç›‘æ§
```bash
# å®æ—¶ç›‘æ§
pm2 monit

# Web ç›‘æ§ç•Œé¢
pm2 web
# è®¿é—® http://localhost:9615

# æ€§èƒ½ç›‘æ§
pm2 show matrixtools
```

### 2. æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹æ—¥å¿—
pm2 logs matrixtools --lines 200

# æ—¥å¿—è½®è½¬
pm2 install pm2-logrotate

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

### 3. å¥åº·æ£€æŸ¥
```javascript
// åœ¨åº”ç”¨ä¸­æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
// pages/api/health.js
export default function handler(req, res) {
  res.status(200).json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
  })
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. éƒ¨ç½²æ£€æŸ¥æ¸…å•
- [ ] ä»£ç å·²æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- [ ] é€šè¿‡æ‰€æœ‰æµ‹è¯•
- [ ] æ„å»ºæˆåŠŸæ— é”™è¯¯
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿ç§»å®Œæˆï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] é™æ€èµ„æºä¸Šä¼ å®Œæˆ
- [ ] PM2 é…ç½®æ–‡ä»¶æ›´æ–°
- [ ] ç›‘æ§å’Œæ—¥å¿—é…ç½®

### 2. é›¶åœæœºéƒ¨ç½²
```bash
# ä½¿ç”¨ PM2 é›¶åœæœºé‡å¯
pm2 reload matrixtools

# æˆ–è€…è“ç»¿éƒ¨ç½²
pm2 start ecosystem.config.js --name matrixtools-green
# æµ‹è¯•é€šè¿‡ååˆ‡æ¢
pm2 stop matrixtools-blue
pm2 restart matrixtools-green --name matrixtools
```

### 3. å›æ»šç­–ç•¥
```bash
# Git å›æ»š
git checkout <previous-commit>
npm run build
pm2 reload matrixtools

# æˆ–è€…ä¿ç•™å¤šä¸ªç‰ˆæœ¬
pm2 start ecosystem.config.js --name matrixtools-v1.0.1
```

### 4. æ€§èƒ½ä¼˜åŒ–
```javascript
// next.config.js ç”Ÿäº§ä¼˜åŒ–
const nextConfig = {
  // å¯ç”¨å‹ç¼©
  compress: true,

  // å›¾ç‰‡ä¼˜åŒ–
  images: {
    formats: ['image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  },

  // è¾“å‡ºé™æ€æ–‡ä»¶
  output: 'standalone', // ç”¨äºDockeréƒ¨ç½²

  // å®éªŒæ€§åŠŸèƒ½
  experimental: {
    optimizeCss: true,
    scrollRestoration: true,
  }
}
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **PM2 è¿›ç¨‹é¢‘ç¹é‡å¯**
   ```bash
   # æ£€æŸ¥é”™è¯¯æ—¥å¿—
   pm2 logs matrixtools --err

   # å¢åŠ æœ€å°è¿è¡Œæ—¶é—´
   min_uptime: '30s'
   ```

2. **å†…å­˜æ³„æ¼**
   ```bash
   # ç›‘æ§å†…å­˜ä½¿ç”¨
   pm2 monit

   # è®¾ç½®å†…å­˜é™åˆ¶
   max_memory_restart: '512M'
   ```

3. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   lsof -i :3000

   # æˆ–è€…ä¿®æ”¹ç«¯å£
   PORT=3001 pm2 start ecosystem.config.js
   ```

é€šè¿‡ä»¥ä¸Šé…ç½®å’Œæµç¨‹ï¼Œæ‚¨çš„ MatrixTools åº”ç”¨å¯ä»¥å®ç°ç¨³å®šå¯é çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œè¿ç»´ç®¡ç†ã€‚