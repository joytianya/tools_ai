# MatrixTools 开发与部署指南

## 📋 目录
1. [开发环境 vs 生产环境](#开发环境-vs-生产环境)
2. [开发流程详解](#开发流程详解)
3. [部署上线流程](#部署上线流程)
4. [PM2 进程管理](#pm2-进程管理)
5. [自动重启机制](#自动重启机制)
6. [最佳实践](#最佳实践)

---

## 🔄 开发环境 vs 生产环境

### 开发环境特点
```bash
# 开发环境启动
npm run dev
# 使用 Next.js 开发服务器 + Turbopack
```

**特性：**
- ✅ **热重载** - 代码修改后自动刷新
- ✅ **源码映射** - 便于调试
- ✅ **详细错误信息** - 完整的错误堆栈
- ✅ **未压缩代码** - 便于阅读和调试
- ⚠️ **性能较慢** - 包含调试信息
- ⚠️ **内存占用高** - 开发工具占用资源

### 生产环境特点
```bash
# 生产环境构建和启动
npm run build
npm start
```

**特性：**
- ✅ **代码优化** - 压缩、Tree-shaking
- ✅ **性能最佳** - 静态资源优化
- ✅ **安全性高** - 移除开发工具
- ✅ **体积最小** - 删除未使用代码
- ❌ **无热重载** - 需要重启应用
- ❌ **错误信息简化** - 用户友好的错误页面

---

## 🛠️ 开发流程详解

### 1. 本地开发启动
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 浏览器访问
open http://localhost:3000
```

### 2. 开发环境特性
```javascript
// next.config.js - 开发环境配置
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 开发环境下的热重载和错误处理
  reactStrictMode: true,
  swcMinify: true,

  // 开发环境特有配置
  experimental: {
    turbo: {
      // Turbopack 配置
    }
  }
}
```

### 3. 开发调试工具
- **Next.js DevTools** - 性能分析
- **React DevTools** - 组件调试
- **浏览器控制台** - 实时日志
- **源码映射** - 精确定位错误

---

## 🚀 部署上线流程

### 1. 构建优化
```bash
# 生产环境构建
npm run build
# 输出: .next 文件夹包含优化后的应用

# 检查构建结果
ls -la .next/
```

### 2. 生产环境启动
```bash
# 方式一：直接启动
npm start

# 方式二：使用 PM2
pm2 start ecosystem.config.js
```

### 3. 构建产物说明
```
.next/
├── static/          # 静态资源（CSS、JS、图片）
├── server/          # 服务端渲染文件
├── cache/           # 构建缓存
└── standalone/      # 独立部署文件（如果启用）
```

### 4. 环境变量配置
```bash
# .env.production
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://api.matrixtools.cn
NEXT_PUBLIC_SITE_URL=https://matrixtools.cn
```

---

## ⚙️ PM2 进程管理

### 1. PM2 配置文件
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'matrixtools',
    script: 'npm',
    args: 'start',
    cwd: '/path/to/matrixtools',

    // 进程管理
    instances: 2,                    // 启动2个实例
    exec_mode: 'cluster',           // 集群模式

    // 自动重启配置
    watch: false,                   // 生产环境不监听文件变化
    max_memory_restart: '1G',       // 内存超过1G时重启

    // 环境变量
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },

    // 日志配置
    out_file: './logs/out.log',
    error_file: './logs/error.log',
    log_file: './logs/combined.log',
    time: true,

    // 重启策略
    autorestart: true,              // 自动重启
    max_restarts: 10,               // 最大重启次数
    min_uptime: '10s',              // 最小运行时间
    restart_delay: 4000,            // 重启延迟
  }]
}
```

### 2. PM2 常用命令
```bash
# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status
pm2 list

# 重启应用
pm2 restart matrixtools
pm2 reload matrixtools    # 零停机重启

# 停止应用
pm2 stop matrixtools
pm2 delete matrixtools

# 查看日志
pm2 logs matrixtools
pm2 logs matrixtools --lines 100

# 监控
pm2 monit
```

### 3. PM2 集群模式
```bash
# 启动多个实例（利用多核CPU）
pm2 start npm --name "matrixtools" -- start -i max

# 或在配置文件中设置
instances: 'max'  # 根据CPU核心数自动设置
```

---

## 🔄 自动重启机制

### 1. PM2 自动重启触发条件
```javascript
// ecosystem.config.js 重启配置详解
{
  // 内存限制重启
  max_memory_restart: '1G',        // 内存超过1GB重启

  // 异常重启
  autorestart: true,               // 进程异常退出时自动重启
  max_restarts: 10,                // 1分钟内最大重启10次
  min_uptime: '10s',               // 进程至少运行10秒才算启动成功

  // 定时重启
  cron_restart: '0 2 * * *',       // 每天凌晨2点重启

  // 文件变化重启（仅开发环境）
  watch: ['src'],                  // 监听 src 目录变化
  ignore_watch: ['node_modules', 'logs'],

  // 重启延迟
  restart_delay: 4000,             // 重启间隔4秒
}
```

### 2. System 级别自动重启

#### Systemd 服务配置
```ini
# /etc/systemd/system/matrixtools.service
[Unit]
Description=MatrixTools Website
After=network.target

[Service]
Type=forking
User=www-data
WorkingDirectory=/var/www/matrixtools
ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
ExecReload=/usr/bin/pm2 reload ecosystem.config.js
ExecStop=/usr/bin/pm2 stop ecosystem.config.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 启用 Systemd 服务
```bash
# 创建服务文件后
sudo systemctl daemon-reload
sudo systemctl enable matrixtools
sudo systemctl start matrixtools

# 查看状态
sudo systemctl status matrixtools
```

### 3. 重启机制对比

| 重启类型 | 触发条件 | 重启速度 | 数据保护 | 适用场景 |
|----------|----------|----------|----------|----------|
| **PM2 热重启** | 代码更新 | 快速(2-3秒) | ✅ 保护 | 代码部署 |
| **PM2 异常重启** | 进程崩溃 | 很快(1-2秒) | ❌ 可能丢失 | 异常恢复 |
| **PM2 内存重启** | 内存超限 | 快速(2-3秒) | ✅ 保护 | 内存泄漏防护 |
| **System 重启** | 系统重启 | 慢(30-60秒) | ✅ 保护 | 服务器重启 |

---

## 📊 监控和日志

### 1. PM2 监控
```bash
# 实时监控
pm2 monit

# Web 监控界面
pm2 web
# 访问 http://localhost:9615

# 性能监控
pm2 show matrixtools
```

### 2. 日志管理
```bash
# 查看日志
pm2 logs matrixtools --lines 200

# 日志轮转
pm2 install pm2-logrotate

# 清空日志
pm2 flush
```

### 3. 健康检查
```javascript
// 在应用中添加健康检查端点
// pages/api/health.js
export default function handler(req, res) {
  res.status(200).json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
  })
}
```

---

## 🎯 最佳实践

### 1. 部署检查清单
- [ ] 代码已提交到版本控制
- [ ] 通过所有测试
- [ ] 构建成功无错误
- [ ] 环境变量配置正确
- [ ] 数据库迁移完成（如需要）
- [ ] 静态资源上传完成
- [ ] PM2 配置文件更新
- [ ] 监控和日志配置

### 2. 零停机部署
```bash
# 使用 PM2 零停机重启
pm2 reload matrixtools

# 或者蓝绿部署
pm2 start ecosystem.config.js --name matrixtools-green
# 测试通过后切换
pm2 stop matrixtools-blue
pm2 restart matrixtools-green --name matrixtools
```

### 3. 回滚策略
```bash
# Git 回滚
git checkout <previous-commit>
npm run build
pm2 reload matrixtools

# 或者保留多个版本
pm2 start ecosystem.config.js --name matrixtools-v1.0.1
```

### 4. 性能优化
```javascript
// next.config.js 生产优化
const nextConfig = {
  // 启用压缩
  compress: true,

  // 图片优化
  images: {
    formats: ['image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  },

  // 输出静态文件
  output: 'standalone', // 用于Docker部署

  // 实验性功能
  experimental: {
    optimizeCss: true,
    scrollRestoration: true,
  }
}
```

---

## 🔧 故障排除

### 常见问题及解决方案

1. **PM2 进程频繁重启**
   ```bash
   # 检查错误日志
   pm2 logs matrixtools --err

   # 增加最小运行时间
   min_uptime: '30s'
   ```

2. **内存泄漏**
   ```bash
   # 监控内存使用
   pm2 monit

   # 设置内存限制
   max_memory_restart: '512M'
   ```

3. **端口冲突**
   ```bash
   # 检查端口占用
   lsof -i :3000

   # 或者修改端口
   PORT=3001 pm2 start ecosystem.config.js
   ```

通过以上配置和流程，您的 MatrixTools 应用可以实现稳定可靠的自动化部署和运维管理。