# 🛠️ MatrixTools 脚本使用指南

## 📋 概述

我已经为您整合了所有脚本，创建了一个统一的管理工具，避免了之前多个脚本之间的冲突问题。现在您可以通过一个脚本管理开发和生产环境的所有操作。

## 🔧 脚本整合说明

### 整合前的问题
- ❌ **多个脚本冲突**：`pm2.sh`、`production.sh`、`restart-service.sh` 功能重叠
- ❌ **路径不一致**：不同脚本中的路径配置不统一
- ❌ **功能分散**：开发和生产环境操作分散在不同文件
- ❌ **维护困难**：修改配置需要同步多个文件

### 整合后的优势
- ✅ **统一入口**：`scripts/manage.sh` 一个脚本管理所有操作
- ✅ **环境分离**：明确区分开发环境和生产环境
- ✅ **智能检测**：自动检测 PM2、sudo 权限等依赖
- ✅ **无冲突设计**：开发和生产环境端口、进程完全分离
- ✅ **详细日志**：彩色输出，清晰的操作反馈

## 🚀 快速开始

### 1. 查看系统状态
```bash
# 检查系统依赖和当前状态
./scripts/manage.sh status
```

### 2. 开发环境操作
```bash
# 启动开发服务器（热重载）
./scripts/manage.sh dev start

# 停止开发服务器
./scripts/manage.sh dev stop

# 重启开发服务器
./scripts/manage.sh dev restart

# 清理开发环境缓存
./scripts/manage.sh dev clean

# 代码检查和格式化
./scripts/manage.sh dev lint
./scripts/manage.sh dev format
```

### 3. 生产环境操作
```bash
# 构建生产版本
./scripts/manage.sh prod build

# 启动生产服务
./scripts/manage.sh prod start

# 查看生产环境状态
./scripts/manage.sh prod status

# 重启生产服务（支持零停机重启）
./scripts/manage.sh prod restart

# 查看生产环境日志
./scripts/manage.sh prod logs

# 一键部署（构建+启动+健康检查）
./scripts/manage.sh prod deploy
```

## 📦 npm 脚本快捷方式

为了更便捷的使用，我还在 `package.json` 中添加了快捷命令：

### 开发环境快捷方式
```bash
npm run dev:start    # 启动开发服务器
npm run dev:stop     # 停止开发服务器
npm run dev:clean    # 清理开发缓存
```

### 生产环境快捷方式
```bash
npm run prod:build   # 构建生产版本
npm run prod:start   # 启动生产服务
npm run prod:deploy  # 一键部署
npm run prod:status  # 查看状态
```

### 其他有用命令
```bash
npm run clean        # 清理构建文件
npm run lint:fix     # 自动修复代码问题
npm run type-check   # TypeScript 类型检查
npm run system:status # 系统状态检查
```

## 🔄 环境分离设计

### 开发环境特点
- **端口**: 默认 3000，支持热重载
- **进程**: `next dev --turbopack`
- **停止方式**: 终止开发服务器进程
- **适用场景**: 日常开发、调试、功能测试

### 生产环境特点
- **端口**: 3000（可配置）
- **进程**: `npm start` 或 PM2 管理
- **停止方式**: 优雅关闭，支持零停机重启
- **适用场景**: 正式部署、用户访问

### 智能冲突处理
```bash
# 脚本会自动检测端口占用
✅ 开发环境启动前检查端口 3000
✅ 生产环境启动前停止开发服务器
✅ 进程优雅关闭，避免僵尸进程
```

## ⚙️ 进程管理对比

| 功能 | 直接启动 | PM2 管理 | 推荐场景 |
|------|----------|----------|----------|
| **进程监控** | ❌ | ✅ | PM2 更适合生产 |
| **自动重启** | ❌ | ✅ | PM2 提供故障恢复 |
| **零停机重启** | ❌ | ✅ | PM2 支持热重载 |
| **日志管理** | 简单 | 完善 | PM2 提供轮转 |
| **集群模式** | ❌ | ✅ | PM2 支持负载均衡 |
| **系统资源** | 低 | 中等 | 根据需求选择 |

## 📊 系统服务集成

### 安装开机自启服务
```bash
# 安装 systemd 服务（需要 sudo 权限）
./scripts/manage.sh install-service

# 之后可以使用系统命令管理
sudo systemctl start matrixtools
sudo systemctl stop matrixtools
sudo systemctl restart matrixtools
sudo systemctl status matrixtools
```

### 服务管理层级
```
1. systemd (系统级)
   ↓
2. PM2 (进程级)
   ↓
3. Node.js App (应用级)
```

## 🔍 故障排查

### 常见问题及解决方案

#### 1. 端口被占用
```bash
# 查看端口占用
lsof -i :3000

# 使用脚本自动处理
./scripts/manage.sh dev start  # 会提示是否停止占用进程
```

#### 2. 进程残留
```bash
# 脚本会自动清理残留进程
./scripts/manage.sh dev stop   # 强制清理开发进程
./scripts/manage.sh prod stop  # 优雅关闭生产进程
```

#### 3. 构建失败
```bash
# 清理缓存后重新构建
./scripts/manage.sh dev clean
./scripts/manage.sh prod build
```

#### 4. PM2 服务异常
```bash
# 检查 PM2 状态
pm2 list
pm2 logs matrixtools-web

# 重置 PM2
pm2 kill
./scripts/manage.sh prod start
```

## 📝 配置文件说明

### 主要配置文件
- `scripts/manage.sh` - 统一管理脚本
- `config/ecosystem.config.js` - PM2 配置
- `package.json` - npm 脚本配置

### 环境变量
```bash
# 开发环境
NODE_ENV=development

# 生产环境
NODE_ENV=production
PORT=3000
```

### 日志文件位置
```
logs/
├── combined.log    # PM2 混合日志
├── out.log        # 标准输出日志
├── error.log      # 错误日志
└── app.log        # 直接启动模式日志
```

## 🎯 最佳实践

### 开发流程
1. `./scripts/manage.sh status` - 检查系统状态
2. `./scripts/manage.sh dev start` - 启动开发服务器
3. 进行开发和调试
4. `./scripts/manage.sh dev lint` - 代码检查
5. `./scripts/manage.sh dev format` - 代码格式化
6. `./scripts/manage.sh dev stop` - 停止开发服务器

### 部署流程
1. `./scripts/manage.sh prod stop` - 停止现有服务
2. `git pull origin main` - 拉取最新代码
3. `./scripts/manage.sh prod deploy` - 一键部署
4. `./scripts/manage.sh prod status` - 检查部署状态
5. 访问 http://localhost:3000 验证服务

### 监控和维护
```bash
# 定期检查系统状态
./scripts/manage.sh status

# 查看生产环境运行状态
./scripts/manage.sh prod status

# 查看最新日志
./scripts/manage.sh prod logs

# 性能监控（如果使用 PM2）
pm2 monit
```

## ⚡ 性能优化建议

### 开发环境
- 使用 Turbopack 加速构建
- 定期清理缓存：`./scripts/manage.sh dev clean`
- 关闭不必要的浏览器标签页

### 生产环境
- 使用 PM2 集群模式（多核 CPU）
- 配置反向代理（Nginx）
- 启用 gzip 压缩
- 设置合理的内存限制

### 配置示例
```javascript
// ecosystem.config.js - 集群模式
{
  instances: 'max',        // 使用所有 CPU 核心
  exec_mode: 'cluster',    // 集群模式
  max_memory_restart: '1G' // 内存限制
}
```

通过这套整合的脚本系统，您可以更高效、更安全地管理 MatrixTools 项目的开发和部署流程！